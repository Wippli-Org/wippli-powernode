<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PDF Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { height: 100vh; overflow: hidden; }
        #adobe-dc-view { width: 100%; height: 100vh; }
        .error { padding: 40px; text-align: center; color: #c62828; background: #ffebee; }
    </style>
</head>
<body>
    <div id="adobe-dc-view"></div>

    <script src="https://acrobatservices.adobe.com/view-sdk/viewer.js"></script>
    <script type="text/javascript">
        // Get PDF URL from query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('pdf');
        const pdfName = urlParams.get('name') || 'document.pdf';

        // Extract wippli-id from PDF name (format: questionnaire-{wippli-id}.pdf or similar)
        const wippliIdMatch = pdfName.match(/wippli[_-](\d+)/i) || pdfName.match(/(\d{3,})/);
        const wippliId = wippliIdMatch ? wippliIdMatch[1] : null;

        if (!pdfUrl) {
            document.getElementById('adobe-dc-view').innerHTML = '<div class="error">Error: No PDF URL provided. Use ?pdf=<url>&name=<filename></div>';
        } else {
            document.addEventListener("adobe_dc_view_sdk.ready", function() {
                try {
                    var adobeDCView = new AdobeDC.View({
                        clientId: "edeb93a6c51c4b1abd9c3d0001a784f2",
                        divId: "adobe-dc-view"
                    });

                    adobeDCView.previewFile({
                        content: {
                            location: {
                                url: pdfUrl
                            }
                        },
                        metaData: {
                            fileName: pdfName,
                            id: "questionnaire-pdf-" + Date.now()
                        }
                    }, {
                        embedMode: "FULL_WINDOW",
                        defaultViewMode: "FIT_PAGE",
                        showDownloadPDF: true,
                        showPrintPDF: true,
                        showAnnotationTools: true,
                        enableAnnotationAPIs: true,
                        includePDFAnnotations: true,
                        enableFormFilling: true,
                        showLeftHandPanel: true,
                        showPageControls: true
                    }).then(function(adobeViewer) {
                        // Get the Annotation Manager to track comment changes
                        adobeViewer.getAnnotationManager().then(function(annotationManager) {
                            console.log('Annotation Manager initialized', wippliId ? '(wippli-id: ' + wippliId + ')' : '(no wippli-id)');

                            // Load existing annotations from Azure if wippli-id is available
                            if (wippliId) {
                                fetch('https://powernode.wippli.ai/api/annotations?wippliId=' + wippliId + '&pdfName=' + encodeURIComponent(pdfName))
                                    .then(function(response) { return response.json(); })
                                    .then(function(data) {
                                        if (data.annotations && data.annotations.length > 0) {
                                            console.log('Loaded ' + data.annotations.length + ' existing annotations');
                                            // Import existing annotations into the PDF
                                            annotationManager.addAnnotations(data.annotations).catch(function(error) {
                                                console.error('Failed to load annotations:', error);
                                            });
                                        }
                                    })
                                    .catch(function(error) {
                                        console.error('Failed to fetch existing annotations:', error);
                                    });
                            }

                            // Function to save annotations to Azure
                            function saveAnnotationsToAzure() {
                                if (!wippliId) {
                                    console.log('No wippli-id, skipping Azure save');
                                    return;
                                }

                                annotationManager.getAnnotations().then(function(annotations) {
                                    fetch('https://powernode.wippli.ai/api/annotations?wippliId=' + wippliId + '&pdfName=' + encodeURIComponent(pdfName), {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({
                                            annotations: annotations,
                                            pdfUrl: pdfUrl
                                        })
                                    })
                                    .then(function(response) { return response.json(); })
                                    .then(function(result) {
                                        console.log('Annotations saved to Azure:', result);
                                    })
                                    .catch(function(error) {
                                        console.error('Failed to save annotations to Azure:', error);
                                    });
                                }).catch(function(error) {
                                    console.error('Failed to get annotations for Azure save:', error);
                                });
                            }

                            // Register callback for ALL annotation events
                            annotationManager.registerEventListener(
                                function(event) {
                                    console.log('Annotation Event:', event.type, event.data);

                                    // Store event in localStorage (backup)
                                    const storageKey = 'pdf-annotations-' + pdfName;
                                    const existingAnnotations = JSON.parse(localStorage.getItem(storageKey) || '[]');

                                    existingAnnotations.push({
                                        timestamp: new Date().toISOString(),
                                        eventType: event.type,
                                        data: event.data
                                    });

                                    localStorage.setItem(storageKey, JSON.stringify(existingAnnotations));

                                    // Save annotations to Azure on every change (debounced)
                                    if (event.type === 'ANNOTATION_ADDED' || event.type === 'ANNOTATION_UPDATED' || event.type === 'ANNOTATION_DELETED') {
                                        // Clear previous timeout if exists
                                        if (window.saveAnnotationsTimeout) {
                                            clearTimeout(window.saveAnnotationsTimeout);
                                        }
                                        // Debounce save by 2 seconds
                                        window.saveAnnotationsTimeout = setTimeout(saveAnnotationsToAzure, 2000);
                                    }

                                    // Also save full snapshot of ALL annotations after each event
                                    annotationManager.getAnnotations().then(function(allAnnotations) {
                                        const snapshotKey = 'pdf-annotations-snapshot-' + pdfName;
                                        localStorage.setItem(snapshotKey, JSON.stringify({
                                            timestamp: new Date().toISOString(),
                                            pdfName: pdfName,
                                            pdfUrl: pdfUrl,
                                            wippliId: wippliId,
                                            annotationCount: allAnnotations.length,
                                            annotations: allAnnotations
                                        }));

                                        // Post message to parent window (if embedded in iframe)
                                        if (window.parent !== window) {
                                            window.parent.postMessage({
                                                type: 'PDF_ANNOTATION_UPDATE',
                                                pdfName: pdfName,
                                                wippliId: wippliId,
                                                eventType: event.type,
                                                annotationCount: allAnnotations.length,
                                                annotations: allAnnotations
                                            }, '*');
                                        }
                                    }).catch(function(error) {
                                        console.error('Failed to get annotations snapshot:', error);
                                    });
                                },
                                {
                                    listenOn: [
                                        "ANNOTATION_ADDED",
                                        "ANNOTATION_UPDATED",
                                        "ANNOTATION_DELETED",
                                        "ANNOTATION_CLICKED",
                                        "ANNOTATION_SELECTED",
                                        "ANNOTATION_UNSELECTED",
                                        "ANNOTATION_MOUSE_ENTER",
                                        "ANNOTATION_MOUSE_LEAVE"
                                    ]
                                }
                            );

                            // Expose API to retrieve all annotations
                            window.getAnnotations = function() {
                                return annotationManager.getAnnotations();
                            };

                            // Expose API to manually save annotations to Azure
                            window.saveAnnotations = function() {
                                saveAnnotationsToAzure();
                                return Promise.resolve({ success: true, message: 'Saving annotations to Azure...' });
                            };

                            // Expose API to export annotations as JSON file
                            window.exportAnnotations = function() {
                                annotationManager.getAnnotations().then(function(annotations) {
                                    console.log('All Annotations:', annotations);
                                    const data = {
                                        wippliId: wippliId,
                                        pdfName: pdfName,
                                        pdfUrl: pdfUrl,
                                        annotationCount: annotations.length,
                                        annotations: annotations,
                                        exportedAt: new Date().toISOString()
                                    };
                                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = (wippliId ? 'wippli-' + wippliId : pdfName.replace('.pdf', '')) + '-annotations.json';
                                    a.click();
                                });
                            };

                            // Expose wippli-id
                            window.getWippliId = function() {
                                return wippliId;
                            };

                            // Expose API to get annotation snapshot from localStorage
                            window.getAnnotationSnapshot = function() {
                                const snapshotKey = 'pdf-annotations-snapshot-' + pdfName;
                                const snapshot = localStorage.getItem(snapshotKey);
                                return snapshot ? JSON.parse(snapshot) : null;
                            };

                            // Expose API to get annotation event history from localStorage
                            window.getAnnotationHistory = function() {
                                const storageKey = 'pdf-annotations-' + pdfName;
                                const history = localStorage.getItem(storageKey);
                                return history ? JSON.parse(history) : [];
                            };

                            // Listen for messages from parent window requesting annotations
                            window.addEventListener('message', function(event) {
                                if (event.data.type === 'REQUEST_PDF_ANNOTATIONS') {
                                    annotationManager.getAnnotations().then(function(annotations) {
                                        event.source.postMessage({
                                            type: 'PDF_ANNOTATIONS_RESPONSE',
                                            pdfName: pdfName,
                                            annotations: annotations,
                                            timestamp: new Date().toISOString()
                                        }, event.origin);
                                    }).catch(function(error) {
                                        console.error('Failed to get annotations for parent:', error);
                                    });
                                }
                            });

                            // Send initial load message to parent
                            if (window.parent !== window) {
                                window.parent.postMessage({
                                    type: 'PDF_VIEWER_READY',
                                    pdfName: pdfName,
                                    pdfUrl: pdfUrl
                                }, '*');
                            }
                        }).catch(function(error) {
                            console.error('Failed to get Annotation Manager:', error);
                        });
                    });

                } catch(error) {
                    document.getElementById('adobe-dc-view').innerHTML = '<div class="error">Error loading PDF: ' + error.message + '</div>';
                    console.error('Adobe viewer error:', error);
                }
            });
        }
    </script>
</body>
</html>
