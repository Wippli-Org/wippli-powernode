<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PDF Viewer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { height: 100vh; overflow: hidden; }
        #adobe-dc-view { width: 100%; height: 100vh; }
        .error { padding: 40px; text-align: center; color: #c62828; background: #ffebee; }

        /* Save status indicator */
        #save-status {
            position: fixed;
            top: 8px;
            right: 12px;
            z-index: 9999;
            padding: 6px 12px;
            border-radius: 4px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        #save-status.saving {
            background: #fff3e0;
            color: #e65100;
        }
        #save-status.saved {
            background: #e8f5e9;
            color: #2e7d32;
        }
        #save-status.error {
            background: #ffebee;
            color: #c62828;
        }
        #save-status .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #save-status .icon {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="save-status" style="display: none;"></div>
    <div id="adobe-dc-view"></div>

    <script src="https://acrobatservices.adobe.com/view-sdk/viewer.js"></script>
    <script type="text/javascript">
        // Global reference to annotation manager (set after preview loads)
        var globalAnnotationManager = null;
        // Global array to track annotations (since getAnnotations() may not work)
        var trackedAnnotations = [];

        // Get PDF URL and user info from query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('pdf');
        const pdfName = urlParams.get('name') || 'document.pdf';

        // Get user info from URL params (can be overridden by blob storage)
        var userId = urlParams.get('userId') || null;
        var userName = urlParams.get('userName') || null;
        var userEmail = urlParams.get('userEmail') || null;
        var userAvatar = urlParams.get('userAvatar') || null;

        // Get wippliId from URL params (preferred) or extract from PDF URL path
        // URL format: .../prologistik-wippli-670/questionnaire-wippli-2025-12-07.pdf
        var wippliId = urlParams.get('wippliId') || null;
        if (!wippliId && pdfUrl) {
            // Extract from container name: prologistik-wippli-XXX (NOT from filename which has date)
            const pathMatch = pdfUrl.match(/prologistik-wippli-(\d+)/i);
            if (pathMatch) {
                wippliId = pathMatch[1];
            }
        }

        console.log('PDF Viewer initializing...', {
            pdfName: pdfName,
            wippliId: wippliId,
            userFromUrl: userId ? 'yes' : 'no'
        });

        // Function to fetch user info from blob storage
        async function fetchUserInfo() {
            if (!wippliId) return null;

            try {
                const response = await fetch('https://powernode.wippli.ai/api/user-info?wippliId=' + wippliId);
                const data = await response.json();
                if (data.userId && data.userName) {
                    console.log('‚úÖ User info loaded from blob storage:', data.userName);
                    return data;
                }
            } catch (error) {
                console.warn('Failed to fetch user info from blob:', error);
            }
            return null;
        }

        // Initialize PDF viewer (called after user info is resolved)
        async function initializeViewer() {
            // If no user info from URL, try to fetch from blob storage
            if (!userId && wippliId) {
                const blobUserInfo = await fetchUserInfo();
                if (blobUserInfo) {
                    userId = blobUserInfo.userId;
                    userName = blobUserInfo.userName;
                    userEmail = blobUserInfo.userEmail || null;
                    userAvatar = blobUserInfo.userAvatar || null;
                }
            }

            // Default to Guest if still no user info
            if (!userName) userName = 'Guest';

            console.log('PDF Viewer initialized:', {
                pdfName: pdfName,
                wippliId: wippliId,
                userId: userId,
                userName: userName,
                userEmail: userEmail,
                userAvatar: userAvatar ? 'provided' : 'none'
            });

            // Configure user profile for commenting
            var viewerConfig = {
                clientId: "edeb93a6c51c4b1abd9c3d0001a784f2",
                divId: "adobe-dc-view"
            };

            var adobeDCView = new AdobeDC.View(viewerConfig);

            // Register user profile callback BEFORE previewFile (required for annotation attribution)
            if (userId && userName && userName !== 'Guest') {
                var userProfileConfig = {
                    userProfile: {
                        name: userName,
                        firstName: userName.split(' ')[0] || userName,
                        lastName: userName.split(' ').slice(1).join(' ') || '',
                        email: userEmail || ''
                    }
                };

                adobeDCView.registerCallback(
                    AdobeDC.View.Enum.CallbackType.GET_USER_PROFILE_API,
                    function() {
                        return new Promise(function(resolve) {
                            resolve(userProfileConfig);
                        });
                    }
                );

                console.log('‚úÖ User profile registered via callback:', userProfileConfig.userProfile);
            } else {
                console.warn('‚ö†Ô∏è User profile NOT configured. Missing:', {
                    userId: userId ? 'OK' : 'MISSING',
                    userName: (userName && userName !== 'Guest') ? 'OK' : 'MISSING'
                });
            }

            // Register SAVE_API callback to handle Adobe's built-in save and clear "Unsaved" indicator
            adobeDCView.registerCallback(
                AdobeDC.View.Enum.CallbackType.SAVE_API,
                function(metaData, content, options) {
                    console.log('Adobe SAVE_API called:', { metaData: metaData, options: options, contentSize: content ? content.byteLength : 0 });

                    // Save annotations in background, return SUCCESS immediately to clear "Unsaved"
                    console.log('SAVE_API: wippliId=' + wippliId + ', trackedAnnotations=' + trackedAnnotations.length);
                    if (wippliId) {
                        // Use trackedAnnotations array instead of getAnnotations()
                        console.log('SAVE_API: Saving ' + trackedAnnotations.length + ' tracked annotations');
                        console.log('SAVE_API: Data:', JSON.stringify(trackedAnnotations).substring(0, 500));
                        fetch('https://powernode.wippli.ai/api/annotations?wippliId=' + wippliId + '&pdfName=' + encodeURIComponent(pdfName), {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ annotations: trackedAnnotations, pdfUrl: pdfUrl })
                        }).then(function() {
                            console.log('‚úÖ Annotations saved to Azure');
                        }).catch(function(err) {
                            console.error('Failed to save annotations:', err);
                        });
                    }

                    // Return SUCCESS immediately to clear "Unsaved" indicator
                    return Promise.resolve({
                        code: AdobeDC.View.Enum.ApiResponseCode.SUCCESS,
                        data: { metaData: metaData }
                    });
                },
                { autoSaveFrequency: 0, enableFocusPolling: false, showSaveButton: true }
            );

            // Build preview config
            var previewConfig = {
                embedMode: "FULL_WINDOW",
                defaultViewMode: "FIT_PAGE",
                showDownloadPDF: true,
                showPrintPDF: true,
                showAnnotationTools: true,
                enableAnnotationAPIs: true,
                includePDFAnnotations: true,
                enableFormFilling: true,
                showLeftHandPanel: true,
                showPageControls: true
            };

                    adobeDCView.previewFile({
                        content: {
                            location: {
                                url: pdfUrl
                            }
                        },
                        metaData: {
                            fileName: pdfName,
                            id: "questionnaire-pdf-" + Date.now()
                        }
                    }, previewConfig).then(function(adobeViewer) {
                        // Get the Annotation Manager to track comment changes
                        adobeViewer.getAnnotationManager().then(function(annotationManager) {
                            // Store globally so SAVE_API callback can access it
                            globalAnnotationManager = annotationManager;
                            console.log('Annotation Manager initialized and stored globally', wippliId ? '(wippli-id: ' + wippliId + ')' : '(no wippli-id)');

                            // Load existing annotations from Azure if wippli-id is available
                            if (wippliId) {
                                fetch('https://powernode.wippli.ai/api/annotations?wippliId=' + wippliId + '&pdfName=' + encodeURIComponent(pdfName))
                                    .then(function(response) { return response.json(); })
                                    .then(function(data) {
                                        if (data.annotations && data.annotations.length > 0) {
                                            console.log('‚úÖ Loaded ' + data.annotations.length + ' existing annotations from Azure');
                                            console.log('Annotation data to import:', JSON.stringify(data.annotations).substring(0, 500));

                                            // Add loaded annotations to trackedAnnotations array
                                            trackedAnnotations = data.annotations.slice(); // Make a copy
                                            console.log('‚úÖ Populated trackedAnnotations with ' + trackedAnnotations.length + ' annotations');

                                            // Import existing annotations into the PDF
                                            annotationManager.addAnnotations(data.annotations)
                                                .then(function(result) {
                                                    console.log('‚úÖ Annotations imported to PDF viewer:', result);
                                                })
                                                .catch(function(error) {
                                                    console.error('‚ùå Failed to import annotations to PDF:', error);
                                                });
                                        } else {
                                            console.log('No existing annotations found for this wippliId');
                                        }
                                    })
                                    .catch(function(error) {
                                        console.error('Failed to fetch existing annotations:', error);
                                    });
                            }

                            // Save status UI helper
                            var saveStatusEl = document.getElementById('save-status');
                            var hideStatusTimeout = null;

                            function showSaveStatus(status, message) {
                                if (hideStatusTimeout) clearTimeout(hideStatusTimeout);
                                saveStatusEl.style.display = 'flex';
                                saveStatusEl.className = status;

                                if (status === 'saving') {
                                    saveStatusEl.innerHTML = '<div class="spinner"></div>' + message;
                                } else if (status === 'saved') {
                                    saveStatusEl.innerHTML = '<span class="icon">‚úì</span>' + message;
                                    hideStatusTimeout = setTimeout(function() {
                                        saveStatusEl.style.display = 'none';
                                    }, 3000);
                                } else if (status === 'error') {
                                    saveStatusEl.innerHTML = '<span class="icon">‚úï</span>' + message;
                                    hideStatusTimeout = setTimeout(function() {
                                        saveStatusEl.style.display = 'none';
                                    }, 5000);
                                }
                            }

                            // Function to save annotations to Azure
                            function saveAnnotationsToAzure() {
                                if (!wippliId) {
                                    console.log('No wippli-id, skipping Azure save');
                                    return;
                                }

                                showSaveStatus('saving', 'Saving...');
                                console.log('saveAnnotationsToAzure: Saving ' + trackedAnnotations.length + ' tracked annotations');

                                // Use trackedAnnotations instead of getAnnotations()
                                fetch('https://powernode.wippli.ai/api/annotations?wippliId=' + wippliId + '&pdfName=' + encodeURIComponent(pdfName), {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        annotations: trackedAnnotations,
                                        pdfUrl: pdfUrl
                                    })
                                })
                                .then(function(response) { return response.json(); })
                                .then(function(result) {
                                    console.log('‚úÖ Annotations saved to Azure:', result);
                                    showSaveStatus('saved', 'Saved');
                                })
                                .catch(function(error) {
                                    console.error('Failed to save annotations to Azure:', error);
                                    showSaveStatus('error', 'Save failed');
                                });
                            }

                            // Register callback for ALL annotation events
                            annotationManager.registerEventListener(
                                function(event) {
                                    console.log('üìù Annotation Event:', event.type);
                                    console.log('üìù Event data:', JSON.stringify(event.data).substring(0, 300));

                                    // Track annotations manually since getAnnotations() may not work
                                    if (event.type === 'ANNOTATION_ADDED' && event.data) {
                                        trackedAnnotations.push(event.data);
                                        console.log('üìù Added annotation to tracked array. Total:', trackedAnnotations.length);
                                    } else if (event.type === 'ANNOTATION_UPDATED' && event.data && event.data.id) {
                                        var idx = trackedAnnotations.findIndex(function(a) { return a.id === event.data.id; });
                                        if (idx >= 0) {
                                            trackedAnnotations[idx] = event.data;
                                            console.log('üìù Updated annotation in tracked array');
                                        }
                                    } else if (event.type === 'ANNOTATION_DELETED' && event.data && event.data.id) {
                                        trackedAnnotations = trackedAnnotations.filter(function(a) { return a.id !== event.data.id; });
                                        console.log('üìù Removed annotation from tracked array. Total:', trackedAnnotations.length);
                                    }

                                    // Store event in localStorage (backup)
                                    const storageKey = 'pdf-annotations-' + pdfName;
                                    const existingAnnotations = JSON.parse(localStorage.getItem(storageKey) || '[]');

                                    existingAnnotations.push({
                                        timestamp: new Date().toISOString(),
                                        eventType: event.type,
                                        data: event.data
                                    });

                                    localStorage.setItem(storageKey, JSON.stringify(existingAnnotations));

                                    // Save annotations to Azure on every change (debounced)
                                    if (event.type === 'ANNOTATION_ADDED' || event.type === 'ANNOTATION_UPDATED' || event.type === 'ANNOTATION_DELETED') {
                                        // Clear previous timeout if exists
                                        if (window.saveAnnotationsTimeout) {
                                            clearTimeout(window.saveAnnotationsTimeout);
                                        }
                                        // Debounce save by 2 seconds
                                        window.saveAnnotationsTimeout = setTimeout(saveAnnotationsToAzure, 2000);
                                    }

                                    // Also save full snapshot of ALL annotations after each event
                                    annotationManager.getAnnotations().then(function(allAnnotations) {
                                        const snapshotKey = 'pdf-annotations-snapshot-' + pdfName;
                                        localStorage.setItem(snapshotKey, JSON.stringify({
                                            timestamp: new Date().toISOString(),
                                            pdfName: pdfName,
                                            pdfUrl: pdfUrl,
                                            wippliId: wippliId,
                                            annotationCount: allAnnotations.length,
                                            annotations: allAnnotations
                                        }));

                                        // Post message to parent window (if embedded in iframe)
                                        if (window.parent !== window) {
                                            window.parent.postMessage({
                                                type: 'PDF_ANNOTATION_UPDATE',
                                                pdfName: pdfName,
                                                wippliId: wippliId,
                                                eventType: event.type,
                                                annotationCount: allAnnotations.length,
                                                annotations: allAnnotations
                                            }, '*');
                                        }
                                    }).catch(function(error) {
                                        console.error('Failed to get annotations snapshot:', error);
                                    });
                                },
                                {
                                    listenOn: [
                                        "ANNOTATION_ADDED",
                                        "ANNOTATION_UPDATED",
                                        "ANNOTATION_DELETED",
                                        "ANNOTATION_CLICKED",
                                        "ANNOTATION_SELECTED",
                                        "ANNOTATION_UNSELECTED",
                                        "ANNOTATION_MOUSE_ENTER",
                                        "ANNOTATION_MOUSE_LEAVE"
                                    ]
                                }
                            );

                            // Expose API to retrieve all annotations
                            window.getAnnotations = function() {
                                return annotationManager.getAnnotations();
                            };

                            // Expose API to manually save annotations to Azure
                            window.saveAnnotations = function() {
                                saveAnnotationsToAzure();
                                return Promise.resolve({ success: true, message: 'Saving annotations to Azure...' });
                            };

                            // Expose API to export annotations as JSON file
                            window.exportAnnotations = function() {
                                annotationManager.getAnnotations().then(function(annotations) {
                                    console.log('All Annotations:', annotations);
                                    const data = {
                                        wippliId: wippliId,
                                        pdfName: pdfName,
                                        pdfUrl: pdfUrl,
                                        annotationCount: annotations.length,
                                        annotations: annotations,
                                        exportedAt: new Date().toISOString()
                                    };
                                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = (wippliId ? 'wippli-' + wippliId : pdfName.replace('.pdf', '')) + '-annotations.json';
                                    a.click();
                                });
                            };

                            // Expose wippli-id
                            window.getWippliId = function() {
                                return wippliId;
                            };

                            // Expose API to get annotation snapshot from localStorage
                            window.getAnnotationSnapshot = function() {
                                const snapshotKey = 'pdf-annotations-snapshot-' + pdfName;
                                const snapshot = localStorage.getItem(snapshotKey);
                                return snapshot ? JSON.parse(snapshot) : null;
                            };

                            // Expose API to get annotation event history from localStorage
                            window.getAnnotationHistory = function() {
                                const storageKey = 'pdf-annotations-' + pdfName;
                                const history = localStorage.getItem(storageKey);
                                return history ? JSON.parse(history) : [];
                            };

                            // Listen for messages from parent window requesting annotations
                            window.addEventListener('message', function(event) {
                                if (event.data.type === 'REQUEST_PDF_ANNOTATIONS') {
                                    annotationManager.getAnnotations().then(function(annotations) {
                                        event.source.postMessage({
                                            type: 'PDF_ANNOTATIONS_RESPONSE',
                                            pdfName: pdfName,
                                            annotations: annotations,
                                            timestamp: new Date().toISOString()
                                        }, event.origin);
                                    }).catch(function(error) {
                                        console.error('Failed to get annotations for parent:', error);
                                    });
                                }
                            });

                            // Send initial load message to parent
                            if (window.parent !== window) {
                                window.parent.postMessage({
                                    type: 'PDF_VIEWER_READY',
                                    pdfName: pdfName,
                                    pdfUrl: pdfUrl
                                }, '*');
                            }
                        }).catch(function(error) {
                            console.error('Failed to get Annotation Manager:', error);
                        });
                    });

        } // end initializeViewer function

        // Main initialization
        if (!pdfUrl) {
            document.getElementById('adobe-dc-view').innerHTML = '<div class="error">Error: No PDF URL provided. Use ?pdf=<url>&name=<filename></div>';
        } else {
            document.addEventListener("adobe_dc_view_sdk.ready", function() {
                initializeViewer().catch(function(error) {
                    document.getElementById('adobe-dc-view').innerHTML = '<div class="error">Error loading PDF: ' + error.message + '</div>';
                    console.error('Adobe viewer error:', error);
                });
            });
        }
    </script>
</body>
</html>
