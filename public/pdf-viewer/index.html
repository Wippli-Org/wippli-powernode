<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PDF Viewer - Prologistik HUB</title>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { padding: 15px; background: #f5f5f5; height: 100vh; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .logo img { height: 31px; padding-top: 5px; }
        .open-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; background: #d32f2f; color: white; text-decoration: none; border-radius: 10px; font-size: 14px; font-weight: 500; transition: background 0.2s; }
        .open-btn:hover { background: #b71c1c; }
        #adobe-dc-view { width: 100%; height: calc(100vh - 90px); border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15); background: white; }
        .footer { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; font-family: 'Barlow', sans-serif; font-size: 12px; color: #666666; }
        .error { padding: 40px; text-align: center; color: #c62828; background: #ffebee; border-radius: 8px; margin: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <img src="https://wipplipdfgen.blob.core.windows.net/prologistik-assets/prologistik-HUB.svg" alt="Prologistik HUB">
        </div>
        <a href="#" id="download-btn" class="open-btn" target="_blank" download>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M14,2H6C4.9,2,4,2.9,4,4v16c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V8L14,2z M6,20V4h7v5h5v11H6z M11,19h2v-4h3l-4-4l-4,4h3V19z"/></svg>
            Download PDF
        </a>
    </div>
    <div id="adobe-dc-view"></div>
    <div class="footer">
        <span>©2025 proLogistik HUB</span>
        <span>Powered by Wippli®</span>
    </div>

    <script src="https://acrobatservices.adobe.com/view-sdk/viewer.js"></script>
    <script type="text/javascript">
        // Get PDF URL from query parameter
        const urlParams = new URLSearchParams(window.location.search);
        const pdfUrl = urlParams.get('pdf');
        const pdfName = urlParams.get('name') || 'document.pdf';

        if (!pdfUrl) {
            document.getElementById('adobe-dc-view').innerHTML = '<div class="error">Error: No PDF URL provided. Use ?pdf=<url>&name=<filename></div>';
        } else {
            // Update download button
            document.getElementById('download-btn').href = pdfUrl;

            document.addEventListener("adobe_dc_view_sdk.ready", function() {
                try {
                    var adobeDCView = new AdobeDC.View({
                        clientId: "edeb93a6c51c4b1abd9c3d0001a784f2",
                        divId: "adobe-dc-view"
                    });

                    adobeDCView.previewFile({
                        content: {
                            location: {
                                url: pdfUrl
                            }
                        },
                        metaData: {
                            fileName: pdfName,
                            id: "questionnaire-pdf-" + Date.now()
                        }
                    }, {
                        embedMode: "FULL_WINDOW",
                        showDownloadPDF: true,
                        showPrintPDF: true,
                        showAnnotationTools: true,
                        enableAnnotationAPIs: true,
                        includePDFAnnotations: true,
                        enableFormFilling: true,
                        showLeftHandPanel: true,
                        showPageControls: true,
                        showAnnotationTools: true
                    }).then(function(adobeViewer) {
                        // Get the Annotation Manager to track comment changes
                        adobeViewer.getAnnotationManager().then(function(annotationManager) {
                            console.log('Annotation Manager initialized');

                            // Register callback for annotation events
                            annotationManager.registerEventListener(
                                function(event) {
                                    console.log('Annotation Event:', event.type, event.data);

                                    // Store annotations in localStorage for retrieval
                                    const storageKey = 'pdf-annotations-' + pdfName;
                                    const existingAnnotations = JSON.parse(localStorage.getItem(storageKey) || '[]');

                                    existingAnnotations.push({
                                        timestamp: new Date().toISOString(),
                                        eventType: event.type,
                                        data: event.data
                                    });

                                    localStorage.setItem(storageKey, JSON.stringify(existingAnnotations));
                                },
                                {
                                    listenOn: [
                                        "ANNOTATION_ADDED",
                                        "ANNOTATION_UPDATED",
                                        "ANNOTATION_DELETED",
                                        "ANNOTATION_CLICKED"
                                    ]
                                }
                            );

                            // Expose API to retrieve all annotations
                            window.getAnnotations = function() {
                                return annotationManager.getAnnotations();
                            };

                            // Expose API to save annotations as JSON
                            window.exportAnnotations = function() {
                                annotationManager.getAnnotations().then(function(annotations) {
                                    console.log('All Annotations:', annotations);
                                    const blob = new Blob([JSON.stringify(annotations, null, 2)], { type: 'application/json' });
                                    const url = URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.download = pdfName.replace('.pdf', '-annotations.json');
                                    a.click();
                                });
                            };
                        }).catch(function(error) {
                            console.error('Failed to get Annotation Manager:', error);
                        });
                    });

                } catch(error) {
                    document.getElementById('adobe-dc-view').innerHTML = '<div class="error">Error loading PDF: ' + error.message + '</div>';
                    console.error('Adobe viewer error:', error);
                }
            });
        }
    </script>
</body>
</html>
