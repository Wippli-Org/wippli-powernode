name: Deploy PowerNode to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: powernodecr.azurecr.io
  IMAGE_NAME: powernode-monitoring
  RESOURCE_GROUP: wippli-powernode-rg

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Clean caches
        run: |
          rm -rf .next node_modules/.cache
          echo "âœ“ Cleaned build caches"

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        run: |
          npm run build
          ls -la .next/standalone || echo "No standalone output"
        env:
          POWERNODE_STORAGE_CONNECTION: ${{ secrets.POWERNODE_STORAGE_CONNECTION }}
          AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}

      - name: Prepare Docker build context
        run: |
          rm -rf build
          mkdir -p build
          cp -r .next/standalone/. build/
          cp -r .next/static build/.next/
          cp -r public build/
          ls -la build/
          ls -la build/.next/

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build and push to ACR
        run: |
          az acr build \
            --registry powernodecr \
            --image ${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --image ${{ env.IMAGE_NAME }}:latest \
            --file Dockerfile \
            .

      - name: Deploy to Container App
        run: |
          az containerapp update \
            --name ${{ env.IMAGE_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --set-env-vars \
              POWERNODE_STORAGE_CONNECTION="${{ secrets.POWERNODE_STORAGE_CONNECTION }}" \
              AZURE_STORAGE_ACCOUNT="${{ secrets.AZURE_STORAGE_ACCOUNT }}" \
              NODE_ENV=production

      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Container App**: ${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group**: ${{ env.RESOURCE_GROUP }}" >> $GITHUB_STEP_SUMMARY
